# NOTE laptopGPDProduction.rnl
# is setup to read the original model output file that is in NETCDF format
# you will need to download this (large) file separately
# pr_day_CCSM4_historical_r1i1p1_19550101-19891231.nc
# and modify the line dataDir  <- "/Users/nychka/Dropbox/Data"
# to where you have put the file 

#define and export name of R namelist This is always required.

    export HPC4StatsNAMELIST=laptopGPDProduction.rnl
     
# run the batch job    
    R CMD batch ../src/supervisorBatch.R  laptopGPD.Rout

# to run the version of this example on cheyenne in UNIX and in the HPC4StatsCMIP/batch directory

qsub cheyenneGPDProduction.pbs

# this by default runs 75 cores on two nodes and covers a
# larger number of latitude bands.

    
#################################################
#checking  results
# with an example how to reassemble from separate chunks
#################################################

# see the plot:
#    laptopGDPProductionPlot.pdf
# for the laptop results

# in R and setting working directory to this batch directory.

   fname<-  dir("../output")
   print( fname)
 # make sure the fname list is just the single file or  chunks of output
 # that you want -- if not just reduce this to be the right subset
 
   look<- matrix( NA, nrow=288, ncol= 192)
   
 # assume everything in fname is a chunk from this run
 # each chunk knows what lon/lat cells that it worked on
 
 for (  iChunk in 1: length( fname)){
    load( paste0("../output/", fname[iChunk]) )
    result <- (get(fname[iChunk]) )$result
    N<- length(result)
    for(  k in 1 : N ){
    temp<- result[[k]]
    # fifth value is return level from fit
    look[temp$I,temp$J] <-  temp$outSummary[,5]
    }
 }   


library( fields)
library( ncdf4)
# To avoid reading the large darta file the lon and lat grid has been
# saved previously:
# dataFileName <- paste0("/Users/nychka/Dropbox/Data/",
#  "pr_day_CCSM4_historical_r1i1p1_19550101-19891231.nc")
# dataHandle <- nc_open(dataFileName)
# lon<- ncvar_get(dataHandle, "lon")
# lat<- ncvar_get(dataHandle,"lat")
# save( lon, lat, file="../data/lonlatCCSM4.rda")
#

load( "../data/lonlatCCSM4.rda")
image.plot( lon,lat, log10(look))
map("world2", add=TRUE)





   